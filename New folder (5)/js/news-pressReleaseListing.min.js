$(document).ready(function() {
    var input = document.getElementById("news-search");
    var newsSearchCount = $("#news-div-data").attr("data-limit-count");
    var staticCount = $("#news-div-data").attr("data-limit-count");
    var itemDisplayedInAutocomlete = parseInt($(".LoadMeMore").attr("data-attr"));
    var dataLength = 0;
    var clicked = "";
    var callAjax;
    var callAjaxforOtherPage;
    var num = getBrowserId();
    var resultUsed = {};
    var searchKeywordCount = parseInt(
      $(".LoadMeMore").attr("data-searchKeywordCount")
    );
    
    var query = $("#unique-category-pressRelease").attr("data-category");
  
    Array.prototype.unique = function() {
      return this.filter(function(value, index, self) {
        return self.indexOf(value) === index;
      });
    };
  
    if (input) {
      var awesomplete = new Awesomplete(input, {
        minChars: 1,
        maxItems: itemDisplayedInAutocomlete, //how many items are needed to be displayed
        autoFirst: true
      });
    }
  
    $.urlParam = function(name) {
      var results = new RegExp("[?&]" + name + "=([^&#]*)").exec(
        window.location.href
      );
      if (results == null) {
        return null;
      } else {
        return decodeURI(results[1]) || 0;
      }
    };
  
    /*if (num != -1) {
      urlParams = new URLSearchParams(window.location.search);
      query = urlParams.get("obj");
    } else if (num == -1) {
      query = $.urlParam("obj");
    }*/
  
    if (query != null) {
      clicked = "fromOther";
      var idd = "#" + query;
  
      $(".news-category").removeClass("active");
      $(idd)
        .parent()
        .addClass("active");
      var newsSearchUrl = $("#news-div-data").attr("data-search-api");
  
      callAjaxforOtherPage = function() {
        var newsLoad = { category: query, count: newsSearchCount };
  
        $.ajax({
          url: newsSearchUrl,
          type: "POST",
          dataType: "json",
          data: newsLoad,
          success: function(json) {
            json=json.data;
            $(".LoadMeMore").removeAttr("hidden");
            $(".loading").css("display", "none");
            dataLength = json.count;
            var limit = 0;
            if (newsSearchCount > json.objects.length) {
              limit = json.objects.length;
            } else {
              limit = newsSearchCount;
            }
  
            var arr = [];
            for (var i = 0; i < limit; i++) {
              arr.push(json.objects[i]);
            }
            var objResult = {};
            objResult.objects = arr;
            createHTML(objResult);
            if (dataLength <= parseInt(newsSearchCount)) {
              $(".LoadMeMore").hide();
            }
          },
          error: function(err) {
            $(".LoadMeMore").removeAttr("hidden");
            $(".loading").css("display", "none");
          }
        });
      };
      callAjaxforOtherPage();
    } else {
      loadPage();
    }
  
    var rawTemplate = document.getElementById("news-listing-template").innerHTML;
  
    function createHTML(newsList) {
      var compiledTemplate = Handlebars.compile(rawTemplate);
      var ourGeneratedHTML = compiledTemplate(newsList);
      var cmtsContainer = document.getElementById("news-listing-content-search");
      cmtsContainer.innerHTML = ourGeneratedHTML;
    }
  
    function loadPage() {
      var newsSearchUrl = $("#news-div-data").attr("data-search-api");
      clicked = "loadPage";
      var divCount1 = $("[name=newsCountSearch]");
      var category = $(divCount1[0]).attr("data-attr");
      $(".LoadMeMore").show();
      $("#noresultsdiv").hide();
  
      var newsLoad = { category: category, count: newsSearchCount };
      $.ajax({
        url: newsSearchUrl,
        type: "POST",
  
        data: newsLoad,
        success: function(json) {
            json=json.data;
          $(".LoadMeMore").removeAttr("hidden");
          $(".loading").css("display", "none");
          var limit = 0;
          dataLength = json.count;
          if (newsSearchCount > json.objects.length) {
            limit = json.objects.length;
          } else {
            limit = newsSearchCount;
          }
  
          var arr = [];
          for (var i = 0; i < limit; i++) {
            arr.push(json.objects[i]);
          }
          var objResult = {};
          objResult.objects = arr;
          createHTML(objResult);
          if (dataLength <= parseInt(newsSearchCount)) {
            $(".LoadMeMore").hide();
          }
        },
        error: function(err) {
          $(".LoadMeMore").removeAttr("hidden");
          $(".loading").css("display", "none");
        }
      });
      return false;
    }
  
    $("#news-search").keypress(function() {
      var newList = [];
      var data = $("#news-search").val();
      var searchQuery = data + "*";
  
      if (data.length >= searchKeywordCount) {
        var newsSearchUrl = $("#news-search").attr("data-search-api");
        $.ajax({
          url: newsSearchUrl,
          method: "POST",
          data: { title: searchQuery, count: "" },
          success: function(result) {
            result=result.data;
            resultUsed = result;
              let searchTerm =$("#news-search").val();
              dataLayer.push({
                'event':'pressReleaseListing',
                'eventCategory':'pressReleaseListing',
                'eventAction':"search",
                'eventLabel':"",
                'wordSearched':searchTerm
               });
            for (i = 0; i < result.objects.length; i++) {
                if (typeof(result.objects[i].title)=="object" && result.objects[i].title[0]) {
                    newList.push(result.objects[i].title[0]);
                }
                //for without v1 api
                if (typeof(result.objects[i].title)=="string" && result.objects[i].title) {
                    newList.push(result.objects[i].title);
                }

                if (typeof(result.objects[i].createdBy)=="object" && result.objects[i].createdBy[0]) {
                    newList.push(result.objects[i].createdBy[0]);
                }
                if (typeof(result.objects[i].createdBy)=="string" && result.objects[i].createdBy[0]) {
                    newList.push(result.objects[i].createdBy);
                }

                if (typeof(result.objects[i].summary)=="object" && result.objects[i].summary[0]) {
                    newList.push(result.objects[i].summary[0]);
                }
                if (typeof(result.objects[i].summary)=="string" && result.objects[i].summary) {
                    newList.push(result.objects[i].summary);
                }
            }
            if (newList.length == 0) {
              $("#noresultsdiv").html($(".LoadMeMore").attr("data-attr-text"));
              $(".LoadMeMore").hide();
              $("#noresultsdiv").show();
              createHTML({ objects: [] });
            }
            awesomplete.list = newList.unique();
          }
        });
      }
    });
  
    $(".news-custom-search").on("awesomplete-selectcomplete", function(e) {
      clicked = "search";
      $(".LoadMeMore").show();
      $("#noresultsdiv").hide();
      var selected = $("#news-search").val();
      var ob;
      var resultFromSolr = [];
      for (var i = 0; i < resultUsed.objects.length; i++) {
        if (
          resultUsed.objects[i].title == selected ||
          resultUsed.objects[i].createdBy == selected ||
          resultUsed.objects[i].summary == selected
        ) {
          resultFromSolr.push(resultUsed.objects[i]);
          ob = { objects: resultFromSolr };
        }
      }
  
      newsSearchCount = staticCount;
      searchfun = function() {
        if (resultFromSolr.length == 0) {
          $("#noresultsdiv").html($(".LoadMeMore").attr("data-attr-text"));
          $(".LoadMeMore").hide();
          $("#noresultsdiv").show();
          createHTML({ objects: [] });
        } else {
          var finalresult = [];
          $(".LoadMeMore").removeAttr("hidden");
          $(".loading").css("display", "none");
          dataLength = resultFromSolr.length;
          var limit = 0;
          if (newsSearchCount > resultFromSolr.length) {
            limit = resultFromSolr.length;
          } else {
            limit = newsSearchCount;
          }
  
          for (i = 0; i < limit; i++) {
            finalresult.push(resultFromSolr[i]);
          }
  
          var finalsortedob = { objects: finalresult };
          createHTML(finalsortedob);
          if (dataLength <= parseInt(newsSearchCount)) {
            $(".LoadMeMore").hide();
          }
        }
      };
      searchfun();
    });
  
    // $(".news-category").click(function() {
    //   $(".news-category").removeClass("active");
    //   $(this).addClass("active");
    //   clicked = "category";
  
    //   $(".LoadMeMore").show();
    //   $("#noresultsdiv").hide();
    //   newsSearchCount = staticCount;
    //   var newsSearchUrlOnClick = $("#news-div-data").attr("data-search-api");
  
    //   var category = $(this).attr("data-category");
  
    //   callAjax = function() {
    //     var tripLoad = { category: category, count: newsSearchCount };
    //     $.ajax({
    //       url: newsSearchUrlOnClick,
    //       type: "POST",
    //       dataType: "json",
    //       data: tripLoad,
    //       success: function(json) {
    //         json=json.data;
    //         $(".LoadMeMore").removeAttr("hidden");
    //         $(".loading").css("display", "none");
    //         var limit = 0;
    //         dataLength = json.count;
    //         if (newsSearchCount > json.objects.length) {
    //           limit = json.objects.length;
    //         } else {
    //           limit = newsSearchCount;
    //         }
    //         var arr = [];
    //         for (var i = 0; i < limit; i++) {
    //           arr.push(json.objects[i]);
    //         }
    //         var objResult = {};
    //         objResult.objects = arr;
    //         createHTML(objResult);
    //         if (dataLength <= parseInt(newsSearchCount)) {
    //           $(".LoadMeMore").hide();
    //         }
    //       },
    //       error: function(err) {
    //         $(".LoadMeMore").removeAttr("hidden");
    //         $(".loading").css("display", "none");
    //       }
    //     });
    //   };
    //   callAjax();
    // });
  
    $(".LoadMeMore").click(function() {
      $(".LoadMeMore").attr("hidden", true);
  
      $(".loading").css("display", "block");
  
      if (dataLength <= parseInt(newsSearchCount)) {
        $(".LoadMeMore").hide();
      }
  
      newsSearchCount = parseInt(newsSearchCount) + parseInt(staticCount);
      if (clicked == "loadPage") {
        loadPage();
      } else if (clicked == "category") {
        callAjax();
      } else if (clicked == "fromOther") {
        callAjaxforOtherPage();
      } else if (clicked == "search") {
        searchfun();
      }
    });
  
    function getBrowserId() {
      var aKeys = ["MSIE", "Firefox", "Safari", "Chrome", "Opera"],
        sUsrAg = navigator.userAgent,
        nIdx = aKeys.length - 1;
      for (nIdx; nIdx > -1 && sUsrAg.indexOf(aKeys[nIdx]) === -1; nIdx--);
      return nIdx;
    }
  });

$(function(){
$(document).on('click','.pressRealseListingAna',function(){
    let ctaText;
    if($(this).hasClass("cta_nv")){
        ctaText = $(this).children("p").attr("data-title");
    }else{
        ctaText = $(this).text().trim();
    }
    let nextPageURL = $(this).attr("href");
    if(nextPageURL == undefined){
        nextPageURL = "";
    }
    dataLayer.push({
        'event':'pressReleaseListing',
        'eventCategory':'pressReleaseListing',
        'eventAction':ctaText,
        'eventLabel':nextPageURL,
    })
});
});

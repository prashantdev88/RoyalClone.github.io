$(document).ready(function () {
    if ($(window).width() <= 767) {
        $(".col-item").each(function () {
            $(this).removeClass("col");
            $(this).addClass("col-sm-12");
        });
    }

    $(window).resize(function () {
        if ($(window).width() <= 767) {
            $(".col-item").each(function () {
                $(this).removeClass("col");
                $(this).addClass("col-sm-12");
            });
        } else {
            $(".col-item").each(function () {
                $(this).removeClass("col-sm-12");
                $(this).addClass("col");
            });
        }
    });
});
var otherStateVal;
var otherCityVal;
var selectState = "";
var selCity = "";
var otherStateErrMsg;
var otherCityErrMsg;
var motorCycleFlagCount = 0;
var dealersOnState;
$(document).ready(function () {
    function showCityDialog(message) {
        $("body").addClass("modal-open");
        $("#CitymyModal").addClass("show");
        $("#CitymyModal").attr("aria-hidden", "false");
        $('<div class="modal-backdrop fade show"><div>').insertAfter("#CitymyModal");
        $("#citymessage").html(message);
        $("#CitymyModal").css("display", "block");

        $(document).on("click", ".close-modal-btn", function (e) {
            $("body").removeClass("modal-open");
            $("#CitymyModal").removeClass("show");
            $("#CitymyModal").attr("aria-hidden", "true");
            $("#CitymyModal").css("display", "none");
            $(".modal-backdrop").remove();
        });
    }

    var ipstackUrl = $("#ipstack-url").attr("data-attr-url");
    var configuratorLeadForm = $("#dealerdropstate").attr("data-lead");
    var regex = "";
    var pattern = "";
    var states = [];
    var geopluginRegion = "";
    var country = "";
    var url_cites = $("#dealerdropstate").attr("url-attr-city");
    var url_states = $("#dealerdropstate").attr("url-attr-state");
    var url_bikes = $("#dealerdropstate").attr("url-attr-bikes");
    var url_dealers = ""; //$("#dealerdropstate").attr("url-attr-dealers");
    var show_price = $("#motorcycle-price-dealer").attr("data-attr-show");
    var show_default_price = $("#motorcycle-price-dealer").attr("data-attr-default-price");
    var default_price = $("#motorcycle-price-dealer").attr("data-default-price");
    var dealerCity = $("#dealerCity").attr('data-attr-dealercity');
    otherStateErrMsg = $(".otherState").attr("data-validation-message");
    otherCityErrMsg = $(".otherCity").attr("data-validation-message");
    dealersOnState = $("#dealerdropstate").attr("state-dealers");
    var emptyMsg = $(".dealers-list").attr("data-empty-msg");
    template = $("#handlebars-dealers").html();
    templateScript = Handlebars.compile(template);
    var dealerRating = $("#motorcycle-price-dealer").attr("dealer-rating");
    var isBtrVal = $("#motorcycle-price-dealer").attr("dealer-btr");
    var getCity = $("#dealerCity").attr("city-url");
    var getStates = $("#dealerCity").attr("state-url");
    var enableCustomData = $("#dealerCity").attr("data-attr-custom-state");
    var customDataApi = $("#dealerCity").attr("data-attr-custom-state-api");
    var cityData = [];
    var customData =
    {
        "Karnataka": [{
            "cityName": "Bengaluru",
            "cityId": "Bengaluru"
        }],
        "Tamil Nadu": [{
            "cityName": "Chennai",
            "cityId": "Chennai"
        }]
    };
    var prioritize = String($(".dynamic-form-container").attr('prioritize'));
    var searchtypeVal = $("#dealerdropstate").attr("service-centre");
    var searchType = "dealer";
    if (searchtypeVal == "true") {
        searchType = "serviceCentres"
    }

    function ipLatLong() {
        $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
            delete options.headers["x-custom-language"];
            delete options.headers["x-custom-country"];
            delete options.headers["authorization"];
            delete options.headers["app_id"];
        });
        $.ajax({
            dataType: "json",
            url: ipstackUrl,
            success: function (data) {
                geopluginRegion = data.region_name;
                for (i = 0; i <= states.length; i++) {
                    regex = "(" + states[i] + ")";
                    pattern = new RegExp(regex, "i");
                    var res = pattern.test(geopluginRegion);
                    //console.log("regex result::" + res);
                    if (res == true) {
                        analyticsFlag = false;
                        $(".state").val(states[i]).change();
                        break;
                    }
                }
            },
            error: function (error) {
                //console.log("error");
            }
        });
    }

    $(document).on("click", ".dealer-dropdown label", function () {
        $(".dealer-dropdown label").removeClass("active");
        $(this).addClass("active");
    });
    var modelCodes = [];
    var attrData = $(".Motorcycle-Campaign-Page-Properties").attr(
        "data-attr-motorcyclefamily"
    );
    if (attrData) {
        modelCodes = attrData.split(",");
    }
    country = $("#dealerdropstate").attr("data-attr-country");
    url_dealers = $("#dealerdropstate").attr("url-attr-dealers");
    var countryUrl;
    if (configuratorLeadForm == "true") {
        countryUrl = url_states + "?country=" + country + "&configuratorCampaign=" + configuratorLeadForm + "&isBTR=" + isBtrVal;
    } else {
        countryUrl = url_states + "?country=" + country + "&searchType=" + searchType + "&isBTR=" + isBtrVal;
    }

    var stateUrl = getStates + "?country=" + country + "&searchType=" + searchType + "&isBTR=" + isBtrVal;
    if (enableCustomData === "true") {
        stateUrl = customDataApi;
    }
    $.ajax({
        url: stateUrl,
        type: "GET",
        success: function (res) {
            let result;
            if (enableCustomData === "true") {
                result = res; // TODO: customData to be changed to res
                customData = result;
                for (let k in result) {
                    states.push(k);
                    $(".state").append("<option value='" + k + "'>" + k + "</option>");
                }
            } else {
                result = res.data;
                states = result;
                result.sort();
                for (j = 0; j < result.length; j++) {
                    $(".state").append("<option value='" + result[j] + "'>" + result[j] + "</option>");
                }
            }
            ipLatLong();
        },
        error: function (error) {
        }
    });

    var stateUrl;
    if (configuratorLeadForm == "true") {
        stateUrl = url_cites + "?country=" + country + "&searchType=" + searchType + "&configuratorCampaign=" + configuratorLeadForm + "&isBTR=" + isBtrVal;
    } else {
        stateUrl = url_cites + "?country=" + country + "&searchType=" + searchType + "&isBTR=" + isBtrVal;
    }
    var cityHTML = $("#city").html();
    if ((show_default_price == "true") && default_price != null) {
        $(".price-icon").html(default_price);
        $(".rupee-icon").removeClass("rupee-icon");
        $(".motorcycle-price").show();
        var data = {
            exShowroomPrice: default_price
        }
        localStorage.setItem("panItem", JSON.stringify(data));
    }
    $(document).on("input", ".otherState", function () {
        otherStateVal = $(this).val().trim();
    });
    $(document).on("input", ".otherCity", function () {
        otherCityVal = $(this).val().trim();
    });
    $(document).on("change", ".state", function () {
        let selectStateAnaVal = $(this).find("option:selected").text().trim();
        $(".dealer-heading").hide();
        $(".input-state").addClass('d-none');
        $(".input-city").addClass('d-none');
        $(".otherState").val("");
        otherStateVal = "";
        $(".otherCity").val("");
        otherCityVal = "";
        $("#city").parent().show();
        $("#city").addClass('df');
        selectState = $("#" + this.id + " option:selected").val();
        if (selectState) {
            $(".dealer-dropdown").html("");
            $(".state").each(function () {
                $(this).val(selectState);
            });
            if (show_default_price != "true" && selectState != "otherState") {
                $.ajax({
                    url: url_bikes,
                    type: "GET",
                    headers: {
                        state: selectState,
                        motorcycle_code: JSON.stringify(modelCodes)
                    },
                    success: function (result) {
                        $(".stateName").html(selectState);
                        localStorage.setItem("panItem", JSON.stringify(result.data));
                        if (show_price == "true") {
                            var value = parseInt(result.data.exShowroomPrice, 10);
                            var priceval = value / 100000;
                            $(".price-icon").html(priceval.toFixed(2) + "L");
                            $(".motorcycle-price").show();
                            let headingAna = $("#motopricestate").parent(".input-box").parent(".col-item").parent(".row").siblings(".state-caption").text().trim();
                            let eventlabelAna = $("#motopricestate").attr("data-placeholder");
                            if (motorCycleFlagCount > 1) {
                                dataLayer.push({
                                    'event': 'motorcyclePrice',
                                    'eventCategory': 'motorcyclePrice',
                                    'eventAction': headingAna,
                                    'eventLabel': eventlabelAna,
                                    'price': priceval.toFixed(2) + "L",
                                    'state': selectStateAnaVal
                                });
                            }
                            motorCycleFlagCount++;
                        }
                        if (configuratorLeadForm == "true") {
                            $(".motorcycle-price").hide();
                        }
                    },
                    error: function (error) {
                        //console.log(error);
                    }
                });
            }
            if (selectState == "otherState") {
                $(".input-state").removeClass('d-none');
                $(".input-city").removeClass('d-none');
                $("#city").parent().hide();
                $("#city").removeClass('df');
                otherStateVal = $(".otherState").val().trim();
            }
            let dealerChecker = $("#dealerdropstate").attr("dealer-listing-not-required");
            if (selectState != "otherState") {
                $("#city").html("");
                $("#city").append(cityHTML);
                $.ajax({
                    url: stateUrl,
                    type: "GET",
                    data: { stateName: selectState },
                    success: function (res) {
                        // locate dealers on the basis of state
                        if (dealersOnState == "true" && dealerChecker != "true") {
                            $.ajax({
                                url: url_dealers,
                                type: "POST",
                                data: JSON.stringify({
                                    state: selectState,
                                    country: country,
                                    searchType: "dealer",
                                    rating: dealerRating,
                                    isBTR: isBtrVal,
                                    prioritize: prioritize

                                }),
                                contentType: "application/json",
                                success: function (result) {
                                    result = result.data;
                                    $(".dealers-list").show();
                                    if (result.length == 0) {
                                        $(".dealer-heading").hide();
                                        $(".dealer-dropdown").html(
                                            "<span class='no-data-text'>" + emptyMsg + "</span>"
                                        );
                                    } else {
                                        $(".dealer-heading").show();
                                        var html = templateScript(result);
                                        $(".dealer-dropdown").html(html);
                                    }
                                },
                                error: function () {
                                }
                            });
                        }
                    },
                    error: function (error) {
                    }
                });
                // cities code.................
                var cityUrl = getCity + "?stateName=" + encodeURIComponent(selectState) + "&country=" + country + "&searchType=" + searchType + "&isBTR=" + isBtrVal;
                if (enableCustomData === "true") {
                    cityData = customData[selectState];
                    console.log(cityData);
                    cityData.sort(function (a, b) {
                        var nameA = a.cityName.toLowerCase();
                        var nameB = b.cityName.toLowerCase();
                        if (nameA < nameB) {
                            return -1;
                        }
                    });
                    for (var j = 0; j < cityData.length; j++) {
                        $("#city").append("<option value='" + cityData[j].cityId + "'>" + cityData[j].cityName + "</option>");
                    }
                } else {
                    $.ajax({
                        url: cityUrl,
                        method: "GET",
                        success: function (result) {
                            let cityData = result.data
                            cityData.sort(function (a, b) {
                                var nameA = a.cityName.toLowerCase();
                                var nameB = b.cityName.toLowerCase();
                                if (nameA < nameB) {
                                    return -1;
                                }
                            });
                            for (var j = 0; j < cityData.length; j++) {
                                $("#city").append("<option value='" + cityData[j].cityId + "'>" + cityData[j].cityName + "</option>");
                            }
                        },
                        error: function (e) {
                        }
                    });
                }
            }
        } else {
            $(".state").val(null);
            if (selectState == "") {
                $("#city").html("");
                $("#city").append(cityHTML);
            }
        }
    });
    $(document).on("change", "#dealerdropstate", function () {
        $(".dealer-dropdown").html("");
    });

    // ajax to populate cities on state change
    var cityHTML = $("#city").html();
    $(document).on("change", "#city", function () {
        $(".otherCity").val("");
        otherCityVal = "";
        var selectCity = $("#city option:selected").html();
        selCity = $("#city").val();
        $(".input-city").addClass('d-none');

        if (selCity == "otherCity") {
            $(".input-city").removeClass('d-none');
            $("#city").addClass('df');
            $(".dealers-list").hide();
        } else if (selCity != "otherCity" && dealersOnState != "true") {

            // locate dealers
            $.ajax({
                url: url_dealers,
                type: "POST",
                data: JSON.stringify({
                    state: selectState,
                    city: selectCity,
                    country: country,
                    searchType: searchType,
                    rating: dealerRating,
                    isBTR: isBtrVal,
                    prioritize: prioritize
                }),
                contentType: "application/json",
                success: function (result) {
                    result = result.data;
                    $(".dealers-list").show();
                    if (result.length == 0) {
                        $(".dealer-heading").hide();
                        $(".dealer-dropdown").html(
                            "<span class='no-data-text'>" + emptyMsg + "</span>"
                        );
                    } else {
                        $(".dealer-heading").show();
                        var html = templateScript(result);
                        $(".dealer-dropdown").html(html);
                    }
                },
                error: function () {
                    //console.log("fail");
                }
            });
        }
    });
    $(document).on("input", ".dealerItemInput", function () {
        let dealerSelected = $(this).prop("checked");
        let dealerValue = "";
        if (dealerSelected == true) {
            dealerValue = $(this).attr('name');
        } else if (dealerSelected == false) {
            dealerValue = $('.dealer-heading').text();
        }
        let dealerPlaceholderText = $('.dealer-heading').text();
        let stateValue = $("#dealerdropstate").find('option:selected').text().trim();
        let cityValue = $("#city").find('option:selected').text().trim();
        dataLayer.push({
            'event': 'dealerDropdown',
            'eventCategory': 'dealerDropdown',
            'eventAction': dealerPlaceholderText,
            'eventLabel': "dealerName",
            'city': cityValue,
            'state': stateValue,
            'dealerName': dealerValue
        });
    });

    var cityArr = [];
    var inputDD = document.getElementById("citySuggestion");
    var awesompleteDD = new Awesomplete(inputDD, {
        minChars: 3,
        autoFirst: true,
        maxItems: 500
    });
    $(".visually-hidden").hide();
    if ($("#citySuggestion").attr("city-suggestionbox") == "true") {
        $("#citySuggestion").on("input", function () {
            let cityValueData = $(this).val();
            var CArr = "";
            var passwAl = /^[-'a-zA-Z ]+$/;
            if ((!passwAl.test(cityValueData) && cityValueData != "") || cityValueData == "") {
                var cityValueDatastr = cityValueData.substring(0, cityValueData.length - 1);
                $("#citySuggestion").val(cityValueDatastr);
            }
            if (cityValueData.length > 3) {
                cityArr = [];
                $.ajax({
                    url: dealerCity + "?city=" + cityValueData + "&country=" + country,
                    type: "GET",
                    success: function (res) {
                        if (res.code == 200) {
                            cityArr.push(res.data);
                            CArr = res.data;
                            awesompleteDD.list = CArr;
                        } else if (res.code == 404) {
                            showCityDialog($("#citySuggestion").attr("invaild-data"));
                            $("#citySuggestion").val("");
                            $("#citySuggestion").blur();
                        } else {
                            showCityDialog($("#citySuggestion").attr("invaild-data"));
                            $("#citySuggestion").val("");
                            $("#citySuggestion").blur();
                        }
                    },
                    error: function (error) {
                    }
                });
            } else {
                CArr = [];
                awesompleteDD.list = CArr;
            }
        });

        $("#citySuggestion").blur(function () {
            var inputVaue = $(this).val();
            if (inputVaue.length < 4 && inputVaue != "") {
                showCityDialog($("#citySuggestion").attr("invaild-data"));
                $("#citySuggestion").val("");
            } else if (!cityArr[0].includes(inputVaue) && inputVaue != "") {
                showCityDialog($("#citySuggestion").attr("invaild-data"));
                $("#citySuggestion").val("");
            } else if (cityArr.includes(inputVaue) && inputVaue != "") {
            }
        });
    }
});


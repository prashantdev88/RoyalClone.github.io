var userId;
var user;
var jwtAccessToken;
var discussUrl;
var userIdNew;

var lang_country = $(".langCountryDiv").attr("data-langcountry");

var country = lang_country.split("_")[0];
var lang = lang_country.split("_")[1];

function CheckCredentials() {
    if (document.cookie.length != 0) {
        var namevaluepair = document.cookie.split("; ");
        for (var i = 0; i < namevaluepair.length; i++) {
            var namevaluearray = namevaluepair[i].split("=");
            if (namevaluearray[0] == "user") {
                user = JSON.parse(namevaluearray[1]);
                userId = user.userId;
            }
        }

        if (!userId) {
        } else if (userId) {
            jwtAccessToken = localStorage.getItem("jwtAccessToken");
        }
    }
    loadDiscussion();
}

$(document).on("click", ".create-discussion", function (e) {
    e.preventDefault();
    var redirectUrl = $("#myDiscussion").attr("data-url");
    if (redirectUrl) {
        redirectUrl = redirectUrl.replace("/content/royal-enfield", "")
    }

    window.location.assign(redirectUrl + ".html");
});

function loadDiscussion() {
    var urlParams = new URLSearchParams(window.location.search);
    var userIdUrl = "";
    if (urlParams.has("userid")) {
        userIdNew = urlParams.get("userid");
    } else {
        userIdNew = $("#myDiscussion").attr("data-userid");
    }

    var discussUrl = $("#myDiscussion").attr("data-discussFetch") + "?userId=" + userIdNew;
    var dataSend = { userId: userId };
    var verifyLogInUrl = $("#myDiscussion").attr("data-verifyTkn");
    var refreshUrl = $("#myDiscussion").attr("data-refreshTkn");
    const verifyTokenPromise = verifyToken(verifyLogInUrl, "promise", refreshUrl);

    verifyTokenPromise.then(function (value) {
        if (value._id) {
            $("#profileImage").attr("src", value.profilePicture);
            setTimeout(userDiscussion, 1500);
            function userDiscussion() {
                var discussionData = collectionData.doc('userInfo').collection("discussionJoined");
                let discussions = [];
                discussionData.get().then(function (querySnapshot) {
                    querySnapshot.forEach(function (doc) {
                        discussions.push(doc.data());
                    })
                    createHTML(discussions);
                }).catch(function (error) {
                    let discussions = [];
                    createHTML(discussions);
                    console.log("No discussions found in Firestore");
                });

            }
        }
    });
}

function createHTML(data) {
    var rawTemplate = $("#discussionTemplate").html();
    var compiledTemplate = Handlebars.compile(rawTemplate);
    var ourGeneratedHTML = compiledTemplate(data);
    var Container = document.getElementById("myDiscussion");
    Container.innerHTML = ourGeneratedHTML;
}

$(document).ready(function () {
    CheckCredentials();
    var aboutMeTxt = $(".about-me-txt").html();
    if (aboutMeTxt) {
        var aboutMeArr = aboutMeTxt.split(" ");
        if (aboutMeArr > 5) {
            $(".read-more").html("Read more....");
        }
    }
});
var windowSize = $(window).width();
if (windowSize < 767) {
    $(".pro-carousel").slick({
        slidesToShow: 1,
        slidesToScroll: 1,
        arrows: false,
        fade: false,
        infinite: false,
        speed: 1000,
        dots: true,
        swipe: true
    });
}

$(".thumb-slider").slick({
    slidesToShow: 3,
    slidesToScroll: 3,
    arrows: true,
    fade: false,
    infinite: false,
    speed: 1000,
    dots: true,
    swipe: true,
    responsive: [
        {
            breakpoint: 800,
            settings: {
                slidesToShow: 2,
                slidesToScroll: 2
            }
        },
        {
            breakpoint: 480,
            settings: {
                slidesToShow: 1,
                slidesToScroll: 1
            }
        }
    ]
});

$(function(){
    $(document).on('click','.create-discussion',function(){
        var nextPageURL = $("#myDiscussion").attr("data-url");
        if(nextPageURL) {
            nextPageURL = nextPageURL.replace("/content/royal-enfield","")
        }
        let ctaText = $(this).text().trim();
        dataLayer.push({
            'event':'userProfileDiscussion',
            'eventCategory':'userProfileDiscussion',
            'eventAction':ctaText,
            'eventLabel':nextPageURL,
            'headingName':""
        });
    });
    
    $(document).on('click','.replyDiscussionAna',function(){
        var nextPageURL = $(this).attr("href");
        let ctaText = $(this).text().trim();
        let headingName = $(this).parent(".count-reply-wrap").parent(".col-sm-2").siblings(".col-sm-10").children("h3").text().trim();
        dataLayer.push({
            'event':'userProfileDiscussion',
            'eventCategory':'userProfileDiscussion',
            'eventAction':ctaText,
            'eventLabel':nextPageURL,
            'headingName':headingName
        });
    });
    });
